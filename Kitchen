import java.awt.*;

public class Kitchen {

    private final Gameplay gameplay;
    private final KitchenProcess process;
    private final KitchenView view;

    private Client activeClient;
    private String order;
    private boolean waitingForAnimation = false;

    public Kitchen(Gameplay gameplay) {
        this.gameplay = gameplay;
        this.process = new KitchenProcess();
        this.view = new KitchenView(process, gameplay);
    }

    public KitchenProcess getProcess() {
        return process;
    }

    public void startOrder(String order, Client client) {
        this.order = order;
        this.activeClient = client;
        this.waitingForAnimation = false;

        process.prepareNewCup();
        view.prepareForNewOrder();
    }

    // UPDATE
    public void update() {
        view.update();

        // 1. Jeśli czekamy na napis
        if (waitingForAnimation) {
            if (!view.isFeedbackActive()) {
                waitingForAnimation = false;
                Game.gameState = Game.State.GAME;
            }
            return;
        }

        // 2. Jeśli wydano napój w ItemsView
        if (process.isServed()) {
            finishOrder();
        }
    }

    // FINALIZACJA ZAMÓWIENIA
    private void finishOrder() {
        int points = 0;
        double earnings = 0.0;

        String clientOrder = activeClient.getOrderName();
        KitchenProcess.BrewType actualDrink = process.getCurrentDrink();

        System.out.println("--- RACHUNEK ---");
        System.out.println("Klient: " + clientOrder + " | Dostał: " + actualDrink);

        boolean correctDrink = false;
        double basePrice = 0.0;

        // 1. LOGIKA ROZPOZNAWANIA NAPOJU

        if (clientOrder.equalsIgnoreCase("Espresso")) {
            basePrice = 10.0;
            if (actualDrink == KitchenProcess.BrewType.ESPRESSO) {
                correctDrink = true; points += 15;
            } else if (actualDrink == KitchenProcess.BrewType.DOUBLE_ESPRESSO) {
                correctDrink = true; points += 15; // Bonus za podwójne
            }
        }
        else if (clientOrder.equalsIgnoreCase("Double Espresso")) {
            basePrice = 14.0;
            if (actualDrink == KitchenProcess.BrewType.DOUBLE_ESPRESSO) {
                correctDrink = true; points += 25;
            } else if (actualDrink == KitchenProcess.BrewType.ESPRESSO) {
                basePrice = 10.0; points -= 5; // Za mało
            }
        }
        else if (clientOrder.equalsIgnoreCase("Americano")) {
            basePrice = 12.0;
            if (actualDrink == KitchenProcess.BrewType.AMERICANO) {
                correctDrink = true; points += 20;
            }
        }
        else if (clientOrder.equalsIgnoreCase("Latte")) {
            basePrice = 16.0;
            if (actualDrink == KitchenProcess.BrewType.LATTE) {
                correctDrink = true; points += 20; // Idealne Latte
            } else if (actualDrink == KitchenProcess.BrewType.CAPPUCCINO) {
                correctDrink = true; points += 5; // Za dużo piany
            }
        }
        else if (clientOrder.equalsIgnoreCase("Cappuccino")) {
            basePrice = 16.0;
            if (actualDrink == KitchenProcess.BrewType.CAPPUCCINO) {
                correctDrink = true; points += 25; // Idealne Cappuccino
            } else if (actualDrink == KitchenProcess.BrewType.LATTE) {
                correctDrink = true; points += 5; // Za mało piany
            }
        }

        // 2. JAKOŚĆ I DODATKI
        if (!correctDrink) {
            points -= 15;
            earnings = 0.0;
        }
        else {
            earnings = basePrice;
            boolean grindPerfect = (process.getCupGrindResult() == KitchenProcess.GrindResult.PERFECT);
            boolean milkPerfect = true;
            boolean milkTypeCorrect = true;

            // Mielenie
            if (grindPerfect) points += 5;
            else if (process.getCupGrindResult() != null) points -= 5;

            // Mleko (Jakość)
            if (actualDrink == KitchenProcess.BrewType.LATTE || actualDrink == KitchenProcess.BrewType.CAPPUCCINO) {
                KitchenProcess.MilkState mState = process.getCupMilkState();

                // Sprawdzamy teksturę (Latte=Perfect, Capp=Foamy)
                boolean textureOk = false;
                if (actualDrink == KitchenProcess.BrewType.LATTE && mState == KitchenProcess.MilkState.PERFECT) textureOk = true;
                if (actualDrink == KitchenProcess.BrewType.CAPPUCCINO && mState == KitchenProcess.MilkState.FOAMY) textureOk = true;

                if (textureOk) {
                    points += 5;
                    milkPerfect = true;
                } else {
                    milkPerfect = false;
                    if (mState == KitchenProcess.MilkState.BURNT) {
                        points -= 10; earnings *= 0.5;
                    } else {
                        points -= 3;
                    }
                }

                // Typ mleka
                if (activeClient.getMilkPreference() != null) {
                    if (activeClient.getMilkPreference() == process.getCupMilkType()) {
                        points += 5; milkTypeCorrect = true;
                    } else {
                        points -= 20; earnings = 0.0; milkTypeCorrect = false; // Kara całkowita
                    }
                }
            }

            // Napiwek
            if (grindPerfect && milkPerfect && milkTypeCorrect && earnings > 0) {
                double tip = basePrice * 0.20;
                earnings += tip;
                points += 10;
            }
        }

        // WYŚWIETLANIE FEEDBACKU
        if (earnings > 0) {
            String msg = String.format("+ %.2f PLN", earnings);
            view.showFeedback(msg, Color.GREEN);
        } else {
            view.showFeedback("ZŁY NAPÓJ!", Color.RED);
        }

        waitingForAnimation = true;

        System.out.println("Zarobek: " + earnings);

        activeClient.acceptOrder();
        gameplay.clientServed(activeClient, points, earnings);
    }

    // INPUT / RENDER
    public void mouseMoved(int mx, int my) { view.mouseMoved(mx, my); }
    public void mouseClicked(int mx, int my) { view.mousePressed(mx, my); }
    public void mouseReleased(int mx, int my) { view.mouseReleased(mx, my); }

    public void render(Graphics g, int w, int h) {
        view.render(g, w, h);

        // UI Kuchni
        g.setColor(new Color(240, 240, 240, 200));
        g.fillRect(0, 0, w, 80);
        g.setColor(Color.BLACK);
        g.drawLine(0, 80, w, 80);

        g.setFont(new Font("Arial", Font.BOLD, 24));
        g.drawString("KUCHNIA", 40, 50);

        g.setFont(new Font("Arial", Font.PLAIN, 18));
        String orderText = order;
        if (activeClient != null && activeClient.getMilkPreference() != null) {
            orderText += " (" + activeClient.getMilkPreference().label + ")";
        }
        g.drawString("Zamówienie: " + orderText, w - 450, 35);

        g.setColor(new Color(30, 100, 30));
        g.drawString(String.format("Kasa: %.2f PLN", gameplay.getMoney()), w - 650, 35);

        // Debug kubka
        KitchenProcess.BrewType current = process.getCurrentDrink();
        String currentName = switch (current) {
            case EMPTY -> "Pusty kubek";
            case HOT_WATER -> "Gorąca woda";
            case ESPRESSO -> "Espresso";
            case DOUBLE_ESPRESSO -> "Double Espresso";
            case AMERICANO -> "Americano";
            case LATTE -> "Latte";
            case CAPPUCCINO -> "Cappuccino";
            case DIRTY_WATER -> "Pomyje";
        };

        if ((current == KitchenProcess.BrewType.LATTE || current == KitchenProcess.BrewType.CAPPUCCINO)
                && process.getCupMilkType() != null) {
            currentName += " (" + process.getCupMilkType().label + ")";
        }

        g.setFont(new Font("Arial", Font.BOLD, 16));
        g.setColor(new Color(60, 60, 100));
        g.drawString("W kubku: " + currentName, w - 450, 65);
    }
}
